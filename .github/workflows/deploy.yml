name: Deploy BarberCRM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          command_timeout: 20m
          script: |
            set +e  # Не останавливаться на ошибках
            
            echo "=========================================="
            echo "BarberCRM Deployment v3.1"
            echo "=========================================="
            
            cd /opt/barber-crm-app || mkdir -p /opt/barber-crm-app && cd /opt/barber-crm-app
            
            # ===================================================================
            # ЖЕСТКАЯ ОСТАНОВКА КОНТЕЙНЕРОВ
            # ===================================================================
            echo ""
            echo "=== Остановка контейнеров ==="
            
            # Функция безопасного kill (без убийства SSH!)
            safe_kill_container() {
                local name=$1
                echo ""
                echo "Останавливаем: $name"
                
                # Проверяем существует ли
                if ! docker ps -a --format '{{.Names}}' | grep -q "^${name}$" 2>/dev/null; then
                    echo "  → Не найден (пропускаем)"
                    return 0
                fi
                
                # Получаем PID
                local pid=$(docker inspect $name --format '{{.State.Pid}}' 2>/dev/null || echo "0")
                
                if [ "$pid" != "0" ] && [ ! -z "$pid" ]; then
                    echo "  → PID: $pid"
                    
                    # Проверяем что это не наш SSH процесс!
                    local current_ssh_pid=$$
                    local parent_ssh_pid=$PPID
                    
                    if [ "$pid" = "$current_ssh_pid" ] || [ "$pid" = "$parent_ssh_pid" ]; then
                        echo "  ⚠ Это SSH процесс! Пропускаем kill"
                    else
                        # Убиваем процесс (попытка 1)
                        kill -9 $pid 2>/dev/null || true
                        sleep 1
                        
                        # Проверяем жив ли
                        if ps -p $pid > /dev/null 2>&1; then
                            echo "  → Процесс жив, попытка 2"
                            kill -9 $pid 2>/dev/null || true
                            sleep 1
                        fi
                    fi
                fi
                
                # Удаляем контейнер
                echo "  → Удаляем контейнер"
                docker rm -f $name 2>/dev/null || true
                
                # Проверка
                if docker ps -a --format '{{.Names}}' | grep -q "^${name}$" 2>/dev/null; then
                    echo "  ⚠ Контейнер все еще есть!"
                else
                    echo "  ✓ Удален"
                fi
            }
            
            # Останавливаем контейнеры
            safe_kill_container "barber_backend"
            safe_kill_container "barber_frontend"
            
            # Очистка containerd shim (БЕЗОПАСНО - исключаем SSH!)
            echo ""
            echo "=== Очистка containerd shim ==="
            
            # Находим PID текущей SSH сессии
            CURRENT_PID=$$
            PARENT_PID=$PPID
            
            # Убиваем только barber-related shim процессы
            ps aux | grep '[c]ontainerd-shim.*barber' | awk '{print $2}' | while read shim_pid; do
                # Не убиваем если это наш процесс или родитель
                if [ "$shim_pid" != "$CURRENT_PID" ] && [ "$shim_pid" != "$PARENT_PID" ]; then
                    echo "  Убиваем shim PID: $shim_pid"
                    kill -9 $shim_pid 2>/dev/null || true
                fi
            done
            
            echo "  ✓ Shim процессы очищены"
            
            # Удаляем сеть
            echo ""
            echo "=== Очистка сети ==="
            docker network rm barber_network 2>/dev/null && echo "  ✓ Сеть удалена" || echo "  → Сети не было"
            
            sleep 2
            
            # ===================================================================
            # ОБНОВЛЕНИЕ КОДА
            # ===================================================================
            echo ""
            echo "=== Обновление кода ==="
            if [ -d .git ]; then
                git fetch --all
                git reset --hard origin/main
                git pull origin main
                echo "  ✓ Код обновлен"
            else
                cd ..
                rm -rf barber-crm-app
                git clone https://github.com/${{ github.repository }} barber-crm-app
                cd barber-crm-app
                echo "  ✓ Репозиторий склонирован"
            fi
            
            # ===================================================================
            # СОЗДАНИЕ .ENV
            # ===================================================================
            echo ""
            echo "=== Создание .env ==="
            cat > .env << 'ENVEOF'
            GOOGLE_SHEET_ID=${{ secrets.GOOGLE_SHEET_ID }}
            GOOGLE_SERVICE_ACCOUNT_JSON=${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
            ENVEOF
            echo "  ✓ .env создан"
            
            # ===================================================================
            # ОЧИСТКА СТАРЫХ ОБРАЗОВ
            # ===================================================================
            echo ""
            echo "=== Очистка образов ==="
            docker rmi barber-crm-app-backend 2>/dev/null && echo "  ✓ backend удален" || true
            docker rmi barber-crm-app-frontend 2>/dev/null && echo "  ✓ frontend удален" || true
            
            # ===================================================================
            # СБОРКА
            # ===================================================================
            echo ""
            echo "=== Сборка образов ==="
            docker compose build --no-cache
            
            if [ $? -ne 0 ]; then
                echo "  ✗ ОШИБКА сборки!"
                exit 1
            fi
            echo "  ✓ Образы собраны"
            
            # ===================================================================
            # ЗАПУСК
            # ===================================================================
            echo ""
            echo "=== Запуск контейнеров ==="
            
            # Создаем сеть
            docker network create barber_network 2>/dev/null || true
            
            # Запускаем backend
            echo "Запускаем Backend..."
            docker run -d \
              --name barber_backend \
              --network barber_network \
              --restart unless-stopped \
              -p 8000:8000 \
              -e "GOOGLE_SHEET_ID=${{ secrets.GOOGLE_SHEET_ID }}" \
              -e "GOOGLE_SERVICE_ACCOUNT_JSON=${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}" \
              barber-crm-app-backend
            
            if [ $? -eq 0 ]; then
                echo "  ✓ Backend запущен"
            else
                echo "  ✗ Ошибка backend!"
                exit 1
            fi
            
            # Запускаем frontend
            echo "Запускаем Frontend..."
            docker run -d \
              --name barber_frontend \
              --network barber_network \
              --restart unless-stopped \
              -p 80:80 \
              barber-crm-app-frontend
            
            if [ $? -eq 0 ]; then
                echo "  ✓ Frontend запущен"
            else
                echo "  ✗ Ошибка frontend!"
                exit 1
            fi
            
            # ===================================================================
            # ПРОВЕРКА
            # ===================================================================
            echo ""
            echo "Ожидание запуска (15 сек)..."
            sleep 15
            
            echo ""
            echo "=========================================="
            echo "Статус:"
            echo "=========================================="
            docker ps --filter "name=barber" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "=== Логи Backend (15 строк) ==="
            docker logs barber_backend --tail=15 2>&1 || echo "Нет логов"
            
            echo ""
            echo "=== Логи Frontend (10 строк) ==="
            docker logs barber_frontend --tail=10 2>&1 || echo "Нет логов"
            
            # Health check
            echo ""
            echo "=== Health Check ==="
            sleep 3
            
            if curl -f http://localhost:8000/health 2>/dev/null >/dev/null; then
                echo "✓ Backend работает!"
            else
                echo "⚠ Backend не отвечает"
            fi
            
            if curl -f http://localhost/ 2>/dev/null >/dev/null; then
                echo "✓ Frontend работает!"
            else
                echo "⚠ Frontend не отвечает"
            fi
            
            # Очистка
            echo ""
            echo "=== Очистка ==="
            docker image prune -f --filter "dangling=true"
            
            echo ""
            echo "=========================================="
            echo "✓ Deployment завершен успешно!"
            echo "=========================================="
            echo ""
            echo "Доступ:"
            echo "  Frontend: http://${{ secrets.SERVER_HOST }}"
            echo "  Backend:  http://${{ secrets.SERVER_HOST }}:8000"
            echo ""
            
            # Успех!
            exit 0