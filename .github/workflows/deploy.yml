name: Deploy BarberCRM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          command_timeout: 20m
          script: |
            set +e
            
            echo "=========================================="
            echo "BarberCRM Deployment v3.2"
            echo "=========================================="
            
            cd /opt/barber-crm-app || mkdir -p /opt/barber-crm-app && cd /opt/barber-crm-app
            
            # ===================================================================
            # ОСТАНОВКА КОНТЕЙНЕРОВ
            # ===================================================================
            echo ""
            echo "=== Остановка контейнеров ==="
            
            stop_container() {
                local name=$1
                echo "Останавливаем: $name"
                
                if ! docker ps -a --format '{{.Names}}' | grep -q "^${name}$" 2>/dev/null; then
                    echo "  → Не найден"
                    return 0
                fi
                
                local pid=$(docker inspect $name --format '{{.State.Pid}}' 2>/dev/null || echo "0")
                
                if [ "$pid" != "0" ] && [ ! -z "$pid" ]; then
                    echo "  → PID: $pid, убиваем"
                    kill -9 $pid 2>/dev/null || true
                    sleep 1
                    
                    if ps -p $pid > /dev/null 2>&1; then
                        kill -9 $pid 2>/dev/null || true
                        sleep 1
                    fi
                fi
                
                docker rm -f $name 2>/dev/null || true
                echo "  ✓ Удален"
            }
            
            stop_container "barber_backend"
            stop_container "barber_frontend"
            
            # Очистка сети
            echo ""
            echo "=== Очистка сети ==="
            docker network rm barber_network 2>/dev/null || true
            
            sleep 2
            
            # ===================================================================
            # ОБНОВЛЕНИЕ КОДА
            # ===================================================================
            echo ""
            echo "=== Обновление кода ==="
            if [ -d .git ]; then
                git fetch --all
                git reset --hard origin/main
                git pull origin main
            else
                cd ..
                rm -rf barber-crm-app
                git clone https://github.com/${{ github.repository }} barber-crm-app
                cd barber-crm-app
            fi
            echo "  ✓ Код обновлен"
            
            # ===================================================================
            # СОЗДАНИЕ .ENV (правильное экранирование!)
            # ===================================================================
            echo ""
            echo "=== Создание .env ==="
            
            # Создаем .env файл с правильным экранированием
            cat > .env << 'ENVEOF'
            GOOGLE_SHEET_ID=${{ secrets.GOOGLE_SHEET_ID }}
            GOOGLE_SERVICE_ACCOUNT_JSON=${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
            ENVEOF
            
            echo "  ✓ .env создан"
            
            # ===================================================================
            # ОЧИСТКА И СБОРКА
            # ===================================================================
            echo ""
            echo "=== Очистка старых образов ==="
            docker rmi barber-crm-app-backend barber-crm-app-frontend 2>/dev/null || true
            
            echo ""
            echo "=== Сборка образов ==="
            docker compose build --no-cache
            
            if [ $? -ne 0 ]; then
                echo "  ✗ ОШИБКА сборки!"
                exit 1
            fi
            echo "  ✓ Собрано"
            
            # ===================================================================
            # ЗАПУСК ЧЕРЕЗ DOCKER COMPOSE (но БЕЗ down!)
            # ===================================================================
            echo ""
            echo "=== Запуск контейнеров ==="
            
            # Создаем сеть вручную
            docker network create barber_network 2>/dev/null || true
            
            # ИСПОЛЬЗУЕМ docker compose up --no-recreate
            # Так как мы УЖЕ удалили старые контейнеры,
            # Docker просто создаст новые БЕЗ попытки остановить старые!
            docker compose up -d --no-recreate
            
            if [ $? -ne 0 ]; then
                echo "  ✗ Ошибка запуска!"
                
                # Fallback: запускаем вручную через docker run с --env-file
                echo "  → Пробуем запуск вручную..."
                
                docker run -d \
                  --name barber_backend \
                  --network barber_network \
                  --restart unless-stopped \
                  -p 8000:8000 \
                  --env-file .env \
                  barber-crm-app-backend
                
                docker run -d \
                  --name barber_frontend \
                  --network barber_network \
                  --restart unless-stopped \
                  -p 80:80 \
                  barber-crm-app-frontend
            fi
            
            echo "  ✓ Запущено"
            
            # ===================================================================
            # ПРОВЕРКА
            # ===================================================================
            echo ""
            echo "Ожидание (15 сек)..."
            sleep 15
            
            echo ""
            echo "=========================================="
            echo "Статус:"
            echo "=========================================="
            docker ps --filter "name=barber"
            
            echo ""
            echo "=== Backend логи ==="
            docker logs barber_backend --tail=20 2>&1
            
            echo ""
            echo "=== Frontend логи ==="
            docker logs barber_frontend --tail=10 2>&1
            
            echo ""
            echo "=== Health Check ==="
            sleep 3
            
            if curl -f http://localhost:8000/health 2>/dev/null; then
                echo "✓ Backend OK"
            else
                echo "⚠ Backend не отвечает"
            fi
            
            if curl -f http://localhost/ 2>/dev/null >/dev/null; then
                echo "✓ Frontend OK"
            else
                echo "⚠ Frontend не отвечает"
            fi
            
            # Очистка
            docker image prune -f --filter "dangling=true"
            
            echo ""
            echo "=========================================="
            echo "✓ Deployment завершен!"
            echo "=========================================="
            echo "Доступ: http://${{ secrets.SERVER_HOST }}"
            echo ""
            
            exit 0