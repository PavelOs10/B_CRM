# Архитектура BarberCRM

## 🏗️ Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                     ПОЛЬЗОВАТЕЛИ                            │
│   (Управляющие филиалов через браузер или телефон)         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                   FRONTEND (React)                          │
│  • Авторизация по филиалам                                  │
│  • 8 вкладок для ввода данных                              │
│  • Автоматические расчеты                                   │
│  • Адаптивный дизайн                                        │
│                                                             │
│  Контейнер: nginx:80                                        │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTP/AJAX
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                  BACKEND API (FastAPI)                      │
│  • REST API endpoints                                       │
│  • Валидация данных (Pydantic)                             │
│  • Бизнес-логика                                            │
│  • Автоматические расчеты                                   │
│                                                             │
│  Контейнер: Python:8000                                     │
└────────────────────┬────────────────────────────────────────┘
                     │ Google Sheets API
                     ↓
┌─────────────────────────────────────────────────────────────┐
│               GOOGLE SHEETS (Хранилище)                     │
│  • Отдельный лист для каждого филиала                      │
│  • Новые записи сверху (insert row index=2)                │
│  • Автоматические формулы                                   │
│  • Доступ через Service Account                            │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 Поток данных

### 1. Вход в систему
```
Пользователь → Выбор филиала → POST /login → Успех → Главная страница
```

### 2. Отправка данных (пример: Утренние мероприятия)
```
Пользователь заполняет форму
    ↓
Нажимает "Отправить"
    ↓
POST /morning-events с JSON данными
    ↓
Backend валидирует через Pydantic
    ↓
Backend подключается к Google Sheets API
    ↓
Находит/создает лист "Утренние мероприятия - [Филиал]"
    ↓
Добавляет заголовки (если их нет)
    ↓
Вставляет данные во 2-ю строку (новые сверху!)
    ↓
Возвращает {success: true}
    ↓
Frontend показывает зеленое уведомление
```

## 📦 Структура контейнеров

### Docker Compose конфигурация:
```yaml
services:
  backend:
    - FastAPI приложение
    - Порт: 8000
    - Переменные окружения из .env
    
  frontend:
    - Nginx + статические файлы
    - Порт: 80
    - Зависит от backend
```

## 🔐 Безопасность

### Уровни защиты:

1. **Авторизация:**
   - JWT токены
   - Привязка к филиалу
   
2. **Google Sheets API:**
   - Service Account аутентификация
   - OAuth 2.0
   - Ограниченные права доступа

3. **Переменные окружения:**
   - Чувствительные данные в .env
   - .env не в Git (в .gitignore)
   - Секреты в GitHub Actions

4. **CORS:**
   - Настроен в FastAPI
   - Защита от XSS

## 📊 Структура данных в Google Sheets

### Для каждого филиала создается 8 листов:

```
Google Spreadsheet
├── Утренние мероприятия - Станкевича
│   ├── Заголовки (строка 1)
│   ├── Последняя запись (строка 2) ← Новые сюда!
│   ├── Предпоследняя запись (строка 3)
│   └── ...
├── Полевые выходы - Станкевича
├── One-on-One - Станкевича
├── Еженедельные показатели - Станкевича
├── Адаптация новичков - Станкевича
├── Планы мастеров - Станкевича
├── Отзывы - Станкевича
└── Сводка - Станкевича
```

### Особенность: Insert Row Index = 2
Вместо `append_row()` используется `insert_row(data, index=2)`:
- Заголовки остаются в строке 1
- Новые данные вставляются в строку 2
- Старые данные сдвигаются вниз
- **Результат:** Самые новые записи всегда наверху!

## 🚀 CI/CD Pipeline (GitHub Actions)

### Процесс автодеплоя:

```
1. Developer делает git push в main
       ↓
2. GitHub Actions запускается
       ↓
3. Checkout кода из репозитория
       ↓
4. Создание .env из GitHub Secrets
       ↓
5. SSH подключение к серверу
       ↓
6. Остановка старых контейнеров
       ↓
7. Удаление старого кода
       ↓
8. Клонирование свежего кода
       ↓
9. Создание .env на сервере
       ↓
10. docker-compose up -d --build
       ↓
11. Очистка старых образов
       ↓
12. ✅ Приложение обновлено!
```

### Время деплоя: ~2-3 минуты

## 🎯 API Endpoints

### Авторизация
- `GET /branches` - Список филиалов
- `POST /login` - Вход с выбором филиала

### Данные (все POST)
- `/morning-events` - Утренние мероприятия
- `/field-visits` - Полевые выходы
- `/one-on-one` - One-on-One встречи
- `/weekly-metrics` - Еженедельные показатели
- `/newbie-adaptation` - Адаптация новичков
- `/master-plans` - Планы мастеров
- `/reviews` - Отзывы
- `/branch-summary` - Сводка филиала

### Формат запроса (пример):
```json
POST /morning-events
[
  {
    "date": "2026-02-08",
    "event_type": "Запуск дня",
    "participants": 8,
    "efficiency": 5,
    "comment": "Все прошло отлично",
    "branch": "Станкевича"
  }
]
```

### Формат ответа:
```json
{
  "success": true,
  "message": "Добавлено 1 записей"
}
```

## 📈 Масштабирование

### Текущая архитектура поддерживает:
- ✅ До 50 филиалов
- ✅ До 100 одновременных пользователей
- ✅ Неограниченное количество записей

### Для роста:
1. **Добавление филиалов:** Просто добавить в массив BRANCHES
2. **Больше пользователей:** Увеличить ресурсы сервера
3. **Большие объемы:** Рассмотреть PostgreSQL вместо Google Sheets

## 🔧 Технологии

### Backend:
- **FastAPI** - современный Python веб-фреймворк
- **Pydantic** - валидация данных
- **gspread** - работа с Google Sheets API
- **google-auth** - аутентификация Google

### Frontend:
- **React 18** - UI библиотека
- **Tailwind CSS** - стилизация
- **Lucide React** - иконки
- **Babel Standalone** - транспиляция JSX

### DevOps:
- **Docker** - контейнеризация
- **Docker Compose** - оркестрация
- **GitHub Actions** - CI/CD
- **Nginx** - веб-сервер

## 🎨 UI/UX Особенности

### Дизайн-система:
- **Шрифт:** Plus Jakarta Sans (современный, читаемый)
- **Цвета:** Индиго-фиолетовый градиент + акценты
- **Скругления:** rounded-xl (12px) для мягкости
- **Тени:** Мягкие shadow-sm, shadow-lg
- **Анимации:** transition-all для плавности

### Компоненты:
- **StarRating** - Интерактивная оценка звездами (1-10)
- **Tabs** - Навигация между вкладками
- **Cards** - Карточки для каждой записи
- **Buttons** - Яркие градиентные кнопки
- **Inputs** - Крупные, удобные поля ввода

## 📱 Адаптивность

### Breakpoints (Tailwind):
- **sm:** 640px (мобильные горизонтально)
- **md:** 768px (планшеты)
- **lg:** 1024px (десктопы)

### Особенности:
- Grid автоматически меняется с 1 до 2-5 колонок
- Кнопки и поля занимают всю ширину на мобильных
- Навигация скроллится горизонтально на телефоне

## 🎓 Обучение новых разработчиков

### Минимальные знания для поддержки:
1. **Python basics** - для понимания backend
2. **React basics** - для работы с frontend
3. **Docker basics** - для деплоя
4. **Git basics** - для работы с кодом

### Первые задачи:
1. Добавить новый филиал в BRANCHES
2. Изменить цвет интерфейса
3. Добавить новое поле в форму
4. Написать новый endpoint

**Документация:**
- README.md - старт для всех
- Комментарии в коде - объяснения логики
- USER_GUIDE.md - как пользоваться
- SERVER_SETUP.md - как деплоить
